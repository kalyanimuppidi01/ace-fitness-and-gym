name: SonarCloud Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Test and Analyze
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # ensure full history for SonarCloud blame/scm info

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install coverage pytest pytest-cov

      - name: Run tests and generate coverage.xml (coverage.py, robust)
        run: |
          set -euo pipefail
          # cleanup any leftover coverage data to avoid stale absolute paths
          rm -f .coverage .coverage.* reports/coverage.xml || true

          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install coverage pytest

          echo "PWD: $(pwd)"
          echo "Python: $(python -V)"
          echo "Running pytest under coverage (source=app)..."

          # Run tests with coverage and force coverage to measure 'app' package
          coverage run --source=app -m pytest -q

          echo "Coverage run exit code: $?"

          # Show coverage report in terminal (helpful to see what's measured)
          echo "=== coverage report ==="
          coverage report -m || true

          # Ensure a .coverage file was produced
          if [ ! -f ".coverage" ]; then
            echo "ERROR: coverage run did not produce .coverage file"
            ls -la
            exit 2
          fi

          # Generate Cobertura XML for SonarCloud
          mkdir -p reports
          coverage xml -o reports/coverage.xml || (echo "coverage xml failed"; exit 3)

          echo "=== reports/coverage.xml head ==="
          head -n 120 reports/coverage.xml || true

      - name: Normalize coverage.xml for SonarCloud (fix any absolute paths)
        run: |
          python - "$PWD" "reports/coverage.xml" <<'PY'
          import sys, xml.etree.ElementTree as ET, pathlib

          repo_root = pathlib.Path(sys.argv[1]).resolve()
          cov = pathlib.Path(sys.argv[2]).resolve()
          print(f"Normalizing coverage file: {cov}")
          tree = ET.parse(cov)
          root = tree.getroot()

          # Set <sources><source> to repo-root/app
          desired_source = str(repo_root / "app")
          sources = root.find("sources")
          if sources is None:
              sources = ET.SubElement(root, "sources")
          for s in list(sources):
              sources.remove(s)
          ET.SubElement(sources, "source").text = desired_source
          print(f"Set <source> to: {desired_source}")

          # Prefix bare filenames with 'app/'
          for cls in root.findall(".//class"):
              f = cls.get("filename")
              if f and not f.startswith("app/") and "/" not in f:
                  cls.set("filename", f"app/{f}")
          for f in root.findall(".//file"):
              n = f.get("name")
              if n and not n.startswith("app/") and "/" not in n:
                  f.set("name", f"app/{n}")

          tree.write(cov, encoding="utf-8", xml_declaration=True)
          print("Normalization complete.")
          PY

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=kalyanimuppidi01
            -Dsonar.projectKey=kalyanimuppidi01_ace-fitness-and-gym
            -Dsonar.sources=app
            -Dsonar.python.coverage.reportPaths=reports/coverage.xml
            -Dsonar.coverage.exclusions=tests/**
            -Dsonar.qualitygate.wait=true
